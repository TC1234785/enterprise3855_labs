services:
  # Core infrastructure
  zookeeper:
    container_name: zookeeper
    image: confluentinc/cp-zookeeper:7.6.1
    user: "0:0"
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    volumes:
      - zookeeper_data:/var/lib/zookeeper/data
      - zookeeper_log:/var/lib/zookeeper/log
    healthcheck:
      test: ["CMD-SHELL", "echo srvr | nc localhost 2181 || exit 1"]
      start_period: 10s
      interval: 5s
      timeout: 5s
      retries: 3

  kafka:
    container_name: kafka
    image: wurstmeister/kafka
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ADVERTISED_HOST_NAME: kafka
      KAFKA_LISTENERS: INSIDE://:29092,OUTSIDE://:9092
      KAFKA_INTER_BROKER_LISTENER_NAME: INSIDE
      KAFKA_ADVERTISED_LISTENERS: INSIDE://kafka:29092,OUTSIDE://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: INSIDE:PLAINTEXT,OUTSIDE:PLAINTEXT
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_CREATE_TOPICS: "events:1:1"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./data/kafka:/kafka
    depends_on:
      zookeeper:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "kafka-broker-api-versions.sh --bootstrap-server localhost:29092 || exit 1"]
      start_period: 30s
      interval: 10s
      timeout: 10s
      retries: 3
    restart: on-failure

  db:
    container_name: db
    image: mysql:latest
    environment:
      MYSQL_ROOT_PASSWORD: password
      MYSQL_DATABASE: traindb
      MYSQL_USER: user
      MYSQL_PASSWORD: password
    volumes:
      - ./data/database:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "user", "--password=password"]
      start_period: 10s
      interval: 5s
      timeout: 5s
      retries: 10

  # Application services (build from local sources)
  receiver:
    build:
      context: ./receiver
      dockerfile: Dockerfile
    environment:
      CORS_ALLOW_ALL: no
    expose:
      - "8080"
    depends_on:
      kafka:
        condition: service_healthy
    volumes:
      - ./config:/config:ro
      - ./logs:/logs
    restart: on-failure
    deploy:
      replicas: 3

  storage:
    container_name: storage
    build:
      context: ./storage
      dockerfile: Dockerfile
    environment:
      CORS_ALLOW_ALL: no
    expose:
      - "8090"
    depends_on:
      db:
        condition: service_healthy
      kafka:
        condition: service_healthy
    volumes:
      - ./config:/config:ro
      - ./logs:/logs
    restart: on-failure

  processing:
    container_name: processing
    build:
      context: ./processing
      dockerfile: Dockerfile
    environment:
      CORS_ALLOW_ALL: no
    expose:
      - "8100"
    depends_on:
      - storage
    volumes:
      - ./config:/config:ro
      - ./logs:/logs
      - ./data/processing:/data/processing

  analyzer:
    container_name: analyzer
    build:
      context: ./analyzer
      dockerfile: Dockerfile
    environment:
      CORS_ALLOW_ALL: no
    expose:
      - "8110"
    depends_on:
      kafka:
        condition: service_healthy
    volumes:
      - ./config:/config:ro
      - ./logs:/logs
    restart: on-failure

  health:
    container_name: health
    build:
      context: ./health
      dockerfile: Dockerfile
    environment:
      CORS_ALLOW_ALL: no
    expose:
      - "8120"
    depends_on:
      - receiver
      - storage
      - processing
      - analyzer
    volumes:
      - ./config:/config:ro
      - ./logs:/logs
      - ./data/health:/data/health
    restart: on-failure

  dashboard:
    container_name: dashboard
    build:
      context: ./dashboard
      dockerfile: Dockerfile
    ports:
      - "80:80"
    depends_on:
      - receiver
      - storage
      - processing
      - analyzer
      - health
    volumes:
      - ./dashboard/nginx.conf:/etc/nginx/conf.d/default.conf:ro

volumes:
  zookeeper_data:
  zookeeper_log:
